<!DOCTYPE html>

<html lang="km">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á”áŸááŸ’ááŸá˜á’á˜áŸŒ</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

```
body { 
  font-family: 'Khmer OS Battambang', 'Khmer OS', Arial, sans-serif; 
  background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
  padding: 20px;
  min-height: 100vh;
}

.container {
  max-width: 1800px;
  margin: 0 auto;
}

.header {
  background: white;
  padding: 25px 30px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  margin-bottom: 20px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  flex-wrap: wrap;
  gap: 15px;
}

.header h1 {
  color: #1e3c72;
  font-size: 26px;
  display: flex;
  align-items: center;
  gap: 10px;
}

.btn-group {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

button {
  border: none;
  padding: 10px 18px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.2s;
  font-family: inherit;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.btn-add { background: #10b981; color: white; }
.btn-export { background: #3b82f6; color: white; }
.btn-print { background: #8b5cf6; color: white; }
.btn-stats { background: #f59e0b; color: white; }
.btn-edit { background: #10b981; color: white; padding: 6px 12px; font-size: 12px; }
.btn-delete { background: #ef4444; color: white; padding: 6px 12px; font-size: 12px; }

.search-section {
  background: white;
  padding: 20px 30px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  margin-bottom: 20px;
}

.search-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 15px;
}

.search-item label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: #1f2937;
  font-size: 14px;
}

.search-item input,
.search-item select {
  width: 100%;
  padding: 10px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
  font-family: inherit;
}

.search-item input:focus,
.search-item select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.table-section {
  background: white;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  overflow: hidden;
}

.table-wrapper {
  overflow-x: auto;
  max-height: 600px;
  overflow-y: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

th {
  background: #1e3c72;
  color: white;
  padding: 12px 10px;
  text-align: left;
  font-weight: 600;
  position: sticky;
  top: 0;
  z-index: 10;
  white-space: nowrap;
  font-size: 13px;
}

td {
  padding: 10px;
  border-bottom: 1px solid #f3f4f6;
  font-size: 13px;
}

tbody tr:hover {
  background: #f9fafb;
}

.action-cell {
  display: flex;
  gap: 5px;
}

.modal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: rgba(0,0,0,0.6);
  overflow-y: auto;
}

.modal-dialog {
  max-width: 900px;
  margin: 30px auto;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}

.modal-header {
  padding: 20px 30px;
  border-bottom: 1px solid #e5e7eb;
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #f9fafb;
}

.modal-header h3 {
  color: #1f2937;
  font-size: 20px;
  font-weight: 600;
}

.close-btn {
  background: #ef4444;
  color: white;
  padding: 8px 16px;
  border-radius: 6px;
  font-size: 14px;
  font-weight: 600;
}

.modal-body {
  padding: 30px;
  max-height: 70vh;
  overflow-y: auto;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 20px;
}

.form-group {
  margin-bottom: 0;
}

.form-group.full-width {
  grid-column: 1 / -1;
}

.form-group label {
  display: block;
  font-weight: 600;
  margin-bottom: 8px;
  color: #1f2937;
  font-size: 14px;
}

.form-group input,
.form-group select {
  width: 100%;
  padding: 10px;
  border: 1px solid #d1d5db;
  border-radius: 6px;
  font-size: 14px;
  font-family: inherit;
}

.form-group input:focus,
.form-group select:focus {
  outline: none;
  border-color: #3b82f6;
  box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.modal-footer {
  padding: 20px 30px;
  border-top: 1px solid #e5e7eb;
  display: flex;
  justify-content: flex-end;
  gap: 10px;
  background: #f9fafb;
}

.btn-save {
  background: #3b82f6;
  color: white;
  padding: 10px 24px;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
}

.btn-cancel {
  background: #6b7280;
  color: white;
  padding: 10px 24px;
  border-radius: 8px;
  font-size: 15px;
  font-weight: 600;
}

.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 15px;
}

.stat-card {
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 20px;
  border-radius: 10px;
  text-align: center;
  box-shadow: 0 4px 12px rgba(0,0,0,0.15);
}

.stat-card h4 {
  font-size: 14px;
  margin-bottom: 10px;
  opacity: 0.9;
}

.stat-card .number {
  font-size: 36px;
  font-weight: bold;
}

.loading {
  text-align: center;
  padding: 60px 20px;
  color: #6b7280;
  font-size: 16px;
}

.empty-state {
  text-align: center;
  padding: 60px 20px;
  color: #6b7280;
}

@media print {
  body { background: white; padding: 0; }
  .header .btn-group, .search-section, .action-cell { display: none !important; }
  .table-wrapper { max-height: none; }
}

@media (max-width: 768px) {
  .form-grid {
    grid-template-columns: 1fr;
  }
  .btn-group {
    width: 100%;
  }
  .btn-group button {
    flex: 1;
  }
}
```

  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ğŸ« á”áŸ’ášá–áŸá“áŸ’á’á‚áŸ’ášá”áŸ‹á‚áŸ’ášá„á”áŸááŸ’ááŸá˜á’á˜áŸŒ</h1>
      <div class="btn-group">
        <button class="btn-add" onclick="openAddModal()">â• á”á“áŸ’ááŸ‚á˜ááŸ’á˜á¸</button>
        <button class="btn-export" onclick="exportToCSV()">ğŸ“Š Export</button>
        <button class="btn-print" onclick="window.print()">ğŸ–¨ï¸ Print</button>
        <button class="btn-stats" onclick="showStats()">ğŸ“ˆ áŸáŸ’áá·áá·</button>
      </div>
    </div>

```
<div class="search-section">
  <div class="search-grid">
    <div class="search-item">
      <label>ğŸ” áŸáŸ’áœáŸ‚á„ášá€áá¶á˜áˆáŸ’á˜áŸ„áŸ‡</label>
      <input type="text" id="searchName" placeholder="á‚áŸ„ááŸ’áá“á¶á˜-á“á¶á˜..." oninput="filterTable()">
    </div>
    <div class="search-item">
      <label>ğŸ“š ááŸ’á“á¶á€áŸ‹á‘á¸ (ááŸ’á˜á¸)</label>
      <select id="searchGrade" onchange="filterTable()">
        <option value="">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
      </select>
    </div>
    <div class="search-item">
      <label>ğŸ« áˆáŸ’á˜áŸ„áŸ‡áŸá¶á›á¶ (ááŸ’á˜á¸)</label>
      <select id="searchSchool" onchange="filterTable()">
        <option value="">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
      </select>
    </div>
    <div class="search-item">
      <label>ğŸŒ ášá¶á‡á’á¶á“á¸/ááŸááŸ’á</label>
      <select id="searchProvince" onchange="filterTable()">
        <option value="">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
      </select>
    </div>
    <div class="search-item">
      <label>ğŸ“ á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–</label>
      <select id="searchStatus" onchange="filterTable()">
        <option value="">á‘á¶áŸ†á„á¢áŸáŸ‹</option>
      </select>
    </div>
  </div>
</div>

<div class="table-section">
  <div class="table-wrapper">
    <div id="tableContent" class="loading">â³ á€áŸ†á–á»á„á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™...</div>
  </div>
</div>
```

  </div>

  <div id="editModal" class="modal">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3 id="modalTitle">âœï¸ á€áŸ‚á”áŸ’ášáŸ‚á‘á·á“áŸ’á“á“áŸá™</h3>
        <button class="close-btn" onclick="closeModal()">âœ– á”á·á‘</button>
      </div>
      <div class="modal-body">
        <div id="formContainer"></div>
      </div>
      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeModal()">á”áŸ„áŸ‡á”á„áŸ‹</button>
        <button class="btn-save" onclick="submitForm()">ğŸ’¾ ášá€áŸ’áŸá¶á‘á»á€</button>
      </div>
    </div>
  </div>

  <div id="statsModal" class="modal">
    <div class="modal-dialog">
      <div class="modal-header">
        <h3>ğŸ“ˆ ášá”á¶á™á€á¶ášááŸáŸáŸ’áá·áá·</h3>
        <button class="close-btn" onclick="closeStatsModal()">âœ– á”á·á‘</button>
      </div>
      <div class="modal-body" id="statsContent"></div>
    </div>
  </div>

  <script>
    const webAppUrl = "https://script.google.com/macros/s/AKfycbx6pxDzhcjJqavOuaD5ObLgfe8POpqWRjIB_g9FQOmpxIhRTftWe2wAFE-tJOfjqmZNEA/exec";
    
    let columns = [];
    let allData = [];
    let filteredData = [];
    let editingRowIndex = null;

    loadData();

    function loadData() {
      document.getElementById("tableContent").innerHTML = '<div class="loading">â³ á€áŸ†á–á»á„á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™...</div>';
      
      fetch(webAppUrl)
        .then(res => {
          if (!res.ok) throw new Error("Network error");
          return res.json();
        })
        .then(data => {
          if (data.length > 0) {
            allData = data;
            filteredData = data;
            columns = Object.keys(data[0]);
            populateFilters();
            renderTable(allData);
          } else {
            document.getElementById("tableContent").innerHTML = `
              <div class="empty-state">
                <h3>ğŸ“­ á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™</h3>
                <p>áŸá¼á˜á…á»á…á”áŸŠá¼áá»á„ "á”á“áŸ’ááŸ‚á˜ááŸ’á˜á¸" áŠá¾á˜áŸ’á”á¸á”á“áŸ’ááŸ‚á˜á‘á·á“áŸ’á“á“áŸá™</p>
              </div>`;
          }
        })
        .catch(err => {
          document.getElementById("tableContent").innerHTML = `
            <div class="empty-state">
              <h3>âŒ á˜á·á“á¢á¶á…á‘á¶á‰á‘á·á“áŸ’á“á“áŸá™á”á¶á“</h3>
              <p>${err.message}</p>
              <p><small>áŸá¼á˜á–á·á“á·ááŸ’á™ Web App URL</small></p>
            </div>`;
        });
    }

    function populateFilters() {
      const grades = [...new Set(allData.map(row => String(row["ááŸ’á“á¶á€áŸ‹á‘á¸ (ááŸ’á˜á¸)"] || "")).filter(Boolean))];
      grades.sort((a, b) => {
        if (a === "á˜ááŸ’ááŸá™áŸ’á™") return 1;
        if (b === "á˜ááŸ’ááŸá™áŸ’á™") return -1;
        return Number(a) - Number(b);
      });
      const gradeSelect = document.getElementById("searchGrade");
      gradeSelect.innerHTML = '<option value="">á‘á¶áŸ†á„á¢áŸáŸ‹</option>';
      grades.forEach(grade => {
        gradeSelect.innerHTML += `<option value="${grade}">${grade}</option>`;
      });

      const schools = [...new Set(allData.map(row => row["áˆáŸ’á˜áŸ„áŸ‡áŸá¶á›á¶ (ááŸ’á˜á¸)"] || "").filter(Boolean))];
      const schoolSelect = document.getElementById("searchSchool");
      schoolSelect.innerHTML = '<option value="">á‘á¶áŸ†á„á¢áŸáŸ‹</option>';
      schools.forEach(school => {
        schoolSelect.innerHTML += `<option value="${school}">${school}</option>`;
      });

      const provinces = [...new Set(allData.map(row => row["ášá¶á‡á’á¶á“á¸/ááŸááŸ’á"] || "").filter(Boolean))];
      const provinceSelect = document.getElementById("searchProvince");
      provinceSelect.innerHTML = '<option value="">á‘á¶áŸ†á„á¢áŸáŸ‹</option>';
      provinces.forEach(province => {
        provinceSelect.innerHTML += `<option value="${province}">${province}</option>`;
      });

      const statuses = [...new Set(allData.map(row => row["á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–"] || "").filter(Boolean))];
      const statusSelect = document.getElementById("searchStatus");
      statusSelect.innerHTML = '<option value="">á‘á¶áŸ†á„á¢áŸáŸ‹</option>';
      statuses.forEach(status => {
        statusSelect.innerHTML += `<option value="${status}">${status}</option>`;
      });
    }

    function filterTable() {
      const nameKeyword = document.getElementById("searchName").value.toLowerCase();
      const gradeFilter = document.getElementById("searchGrade").value;
      const schoolFilter = document.getElementById("searchSchool").value;
      const provinceFilter = document.getElementById("searchProvince").value;
      const statusFilter = document.getElementById("searchStatus").value;

      filteredData = allData.filter(row => {
        const name = (row["á‚áŸ„ááŸ’áá“á¶á˜-á“á¶á˜"] || "").toLowerCase();
        const grade = String(row["ááŸ’á“á¶á€áŸ‹á‘á¸ (ááŸ’á˜á¸)"] || "");
        const school = row["áˆáŸ’á˜áŸ„áŸ‡áŸá¶á›á¶ (ááŸ’á˜á¸)"] || "";
        const province = row["ášá¶á‡á’á¶á“á¸/ááŸááŸ’á"] || "";
        const status = row["á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–"] || "";

        return name.includes(nameKeyword) &&
               (!gradeFilter || grade === gradeFilter) &&
               (!schoolFilter || school === schoolFilter) &&
               (!provinceFilter || province === provinceFilter) &&
               (!statusFilter || status === statusFilter);
      });

      renderTable(filteredData);
    }

    function renderTable(data) {
      if (data.length === 0) {
        document.getElementById("tableContent").innerHTML = `
          <div class="empty-state">
            <h3>ğŸ” ášá€á˜á·á“áƒá¾á‰</h3>
            <p>á‚áŸ’á˜á¶á“á‘á·á“áŸ’á“á“áŸá™ááŸ’ášá¼áœá“á¹á„á›á€áŸ’ááááŸ’áŒáŸáŸ’áœáŸ‚á„ášá€</p>
          </div>`;
        return;
      }

      let html = "<table><thead><tr><th>áŸá€á˜áŸ’á˜á—á¶á–</th>";
      columns.forEach(col => html += `<th>${col}</th>`);
      html += "</tr></thead><tbody>";

      data.forEach(row => {
        const originalIndex = allData.indexOf(row);
        html += "<tr><td><div class='action-cell'>";
        html += `<button class="btn-edit" onclick="openEditModal(${originalIndex})">âœï¸ á€áŸ‚</button>`;
        html += `<button class="btn-delete" onclick="deleteStudent(${originalIndex})">ğŸ—‘ï¸</button>`;
        html += "</div></td>";
        columns.forEach(col => html += `<td>${row[col] || ""}</td>`);
        html += "</tr>";
      });

      html += "</tbody></table>";
      document.getElementById("tableContent").innerHTML = html;
    }

    function openEditModal(index) {
      editingRowIndex = index;
      const row = allData[index];
      
      let formHTML = '<div class="form-grid">';
      
      columns.forEach(col => {
        const value = row[col] || "";
        const isGrade = col.includes("ááŸ’á“á¶á€áŸ‹á‘á¸");
        const isGender = col === "á—áŸá‘";
        const isStatus = col === "á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–";
        
        let fieldClass = "form-group";
        if (col === "á‚áŸ„ááŸ’áá“á¶á˜-á“á¶á˜" || col.includes("áˆáŸ’á˜áŸ„áŸ‡áŸá¶á›á¶")) {
          fieldClass += " full-width";
        }
        
        formHTML += `<div class="${fieldClass}"><label>${col}</label>`;
        
        if (isGrade) {
          formHTML += `<select name="${col}">
            <option value="">á‡áŸ’ášá¾áŸášá¾áŸ</option>
            <option value="á˜ááŸ’ááŸá™áŸ’á™" ${value === "á˜ááŸ’ááŸá™áŸ’á™" ? "selected" : ""}>á˜ááŸ’ááŸá™áŸ’á™</option>`;
          for (let i = 1; i <= 12; i++) {
            formHTML += `<option value="${i}" ${String(value) === String(i) ? "selected" : ""}>${i}</option>`;
          }
          formHTML += `</select>`;
        } else if (isGender) {
          formHTML += `<select name="${col}">
            <option value="">á‡áŸ’ášá¾áŸášá¾áŸ</option>
            <option value="á”áŸ’ášá»áŸ" ${value === "á”áŸ’ášá»áŸ" ? "selected" : ""}>á”áŸ’ášá»áŸ</option>
            <option value="áŸáŸ’ášá¸" ${value === "áŸáŸ’ášá¸" ? "selected" : ""}>áŸáŸ’ášá¸</option>
          </select>`;
        } else if (isStatus) {
          formHTML += `<select name="${col}">
            <option value="">á‡áŸ’ášá¾áŸášá¾áŸ</option>
            <option value="á€áŸ†á–á»á„áŸá·á€áŸ’áŸá¶" ${value === "á€áŸ†á–á»á„áŸá·á€áŸ’áŸá¶" ? "selected" : ""}>á€áŸ†á–á»á„áŸá·á€áŸ’áŸá¶</option>
            <option value="á”á¶á“á”á‰áŸ’á…á”áŸ‹" ${value === "á”á¶á“á”á‰áŸ’á…á”áŸ‹" ? "selected" : ""}>á”á¶á“á”á‰áŸ’á…á”áŸ‹</option>
            <option value="á”áŸ„áŸ‡á”á„áŸ‹" ${value === "á”áŸ„áŸ‡á”á„áŸ‹" ? "selected" : ""}>á”áŸ„áŸ‡á”á„áŸ‹</option>
          </select>`;
        } else {
          formHTML += `<input type="text" name="${col}" value="${value}">`;
        }
        
        formHTML += `</div>`;
      });
      
      formHTML += '</div>';
      document.getElementById("formContainer").innerHTML = formHTML;
      document.getElementById("modalTitle").textContent = "âœï¸ á€áŸ‚á”áŸ’ášáŸ‚á‘á·á“áŸ’á“á“áŸá™";
      document.getElementById("editModal").style.display = "block";
    }

    function openAddModal() {
      editingRowIndex = null;
      
      let formHTML = '<div class="form-grid">';
      
      columns.forEach(col => {
        const isGrade = col.includes("ááŸ’á“á¶á€áŸ‹á‘á¸");
        const isGender = col === "á—áŸá‘";
        const isStatus = col === "á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–";
        
        let fieldClass = "form-group";
        if (col === "á‚áŸ„ááŸ’áá“á¶á˜-á“á¶á˜" || col.includes("áˆáŸ’á˜áŸ„áŸ‡áŸá¶á›á¶")) {
          fieldClass += " full-width";
        }
        
        formHTML += `<div class="${fieldClass}"><label>${col}</label>`;
        
        if (isGrade) {
          formHTML += `<select name="${col}">
            <option value="">á‡áŸ’ášá¾áŸášá¾áŸ</option>
            <option value="á˜ááŸ’ááŸá™áŸ’á™">á˜ááŸ’ááŸá™áŸ’á™</option>`;
          for (let i = 1; i <= 12; i++) {
            formHTML += `<option value="${i}">${i}</option>`;
          }
          formHTML += `</select>`;
        } else if (isGender) {
          formHTML += `<select name="${col}">
            <option value="">á‡áŸ’ášá¾áŸášá¾áŸ</option>
            <option value="á”áŸ’ášá»áŸ">á”áŸ’ášá»áŸ</option>
            <option value="áŸáŸ’ášá¸">áŸáŸ’ášá¸</option>
          </select>`;
        } else if (isStatus) {
          formHTML += `<select name="${col}">
            <option value="">á‡áŸ’ášá¾áŸášá¾áŸ</option>
            <option value="á€áŸ†á–á»á„áŸá·á€áŸ’áŸá¶">á€áŸ†á–á»á„áŸá·á€áŸ’áŸá¶</option>
            <option value="á”á¶á“á”á‰áŸ’á…á”áŸ‹">á”á¶á“á”á‰áŸ’á…á”áŸ‹</option>
            <option value="á”áŸ„áŸ‡á”á„áŸ‹">á”áŸ„áŸ‡á”á„áŸ‹</option>
          </select>`;
        } else {
          formHTML += `<input type="text" name="${col}" placeholder="á”á‰áŸ’á…á¼á› ${col}">`;
        }
        
        formHTML += `</div>`;
      });
      
      formHTML += '</div>';
      document.getElementById("formContainer").innerHTML = formHTML;
      document.getElementById("modalTitle").textContent = "â• á”á“áŸ’ááŸ‚á˜á‘á·á“áŸ’á“á“áŸá™ááŸ’á˜á¸";
      document.getElementById("editModal").style.display = "block";
    }

    function closeModal() {
      document.getElementById("editModal").style.display = "none";
      editingRowIndex = null;
    }

    function submitForm() {
      const inputs = document.querySelectorAll("#formContainer input, #formContainer select");
      const payload = {};
      
      inputs.forEach(input => {
        payload[input.name] = input.value.trim();
      });

      if (editingRowIndex !== null) {
        payload.rowIndex = editingRowIndex + 2;
        payload.isEdit = true;
      }

      fetch(webAppUrl, {
        method: "POST",
        body: JSON.stringify(payload)
      })
      .then(res => res.text())
      .then(msg => {
        alert(msg);
        closeModal();
        loadData();
      })
      .catch(err => alert("âŒ á€áŸ†á á»áŸ: " + err.message));
    }

    function deleteStudent(index) {
      const row = allData[index];
      const name = row["á‚áŸ„ááŸ’áá“á¶á˜-á“á¶á˜"] || "";
      
      if (!confirm(`áá¾á¢áŸ’á“á€á”áŸ’ášá¶á€áŠáá¶á…á„áŸ‹á›á»á” "${name}" á˜áŸ‚á“á‘áŸ?`)) return;

      fetch(webAppUrl, {
        method: "POST",
        body: JSON.stringify({
          isDelete: true,
          rowIndex: index + 2
        })
      })
      .then(res => res.text())
      .then(msg => {
        alert(msg);
        loadData();
      })
      .catch(err => alert("âŒ á€áŸ†á á»áŸ: " + err.message));
    }

    function exportToCSV() {
      let csv = "\ufeff" + columns.join(",") + "\n";
      filteredData.forEach(row => {
        csv += columns.map(col => `"${row[col] || ""}"`).join(",") + "\n";
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = `equity_cards_${new Date().toISOString().slice(0,10)}.csv`;
      link.click();
    }

    function showStats() {
      const total = allData.length;
      const gradeStats = {};
      const statusStats = {};
      const provinceStats = {};
      const genderStats = {};

      allData.forEach(row => {
        const grade = String(row["ááŸ’á“á¶á€áŸ‹á‘á¸ (ááŸ’á˜á¸)"] || "N/A");
        const status = row["á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–"] || "N/A";
        const province = row["ášá¶á‡á’á¶á“á¸/ááŸááŸ’á"] || "N/A";
        const gender = row["á—áŸá‘"] || "N/A";
        
        gradeStats[grade] = (gradeStats[grade] || 0) + 1;
        statusStats[status] = (statusStats[status] || 0) + 1;
        provinceStats[province] = (provinceStats[province] || 0) + 1;
        genderStats[gender] = (genderStats[gender] || 0) + 1;
      });

      let html = `<h3 style="margin-bottom:15px;">ğŸ“Š áŸášá»á”</h3><div class="stats-grid">
        <div class="stat-card"><h4>áŸášá»á”á‘á¶áŸ†á„á¢áŸáŸ‹</h4><div class="number">${total}</div></div>`;

      Object.entries(genderStats).forEach(([gender, count]) => {
        html += `<div class="stat-card"><h4>${gender}</h4><div class="number">${count}</div></div>`;
      });

      html += `</div><br><h3 style="margin-bottom:15px;">ğŸ“š áá¶á˜ááŸ’á“á¶á€áŸ‹</h3><div class="stats-grid">`;
      Object.entries(gradeStats).forEach(([grade, count]) => {
        html += `<div class="stat-card"><h4>ááŸ’á“á¶á€áŸ‹á‘á¸ ${grade}</h4><div class="number">${count}</div></div>`;
      });

      html += `</div><br><h3 style="margin-bottom:15px;">ğŸ“ áá¶á˜á”á…áŸ’á…á»á”áŸ’á”á“áŸ’á“á—á¶á–</h3><div class="stats-grid">`;
      Object.entries(statusStats).forEach(([status, count]) => {
        html += `<div class="stat-card"><h4>${status}</h4><div class="number">${count}</div></div>`;
      });

      html += `</div><br><h3 style="margin-bottom:15px;">ğŸŒ áá¶á˜ášá¶á‡á’á¶á“á¸/ááŸááŸ’á</h3><div class="stats-grid">`;
      Object.entries(provinceStats).forEach(([province, count]) => {
        html += `<div class="stat-card"><h4>${province}</h4><div class="number">${count}</div></div>`;
      });

      html += `</div>`;
      
      document.getElementById("statsContent").innerHTML = html;
      document.getElementById("statsModal").style.display = "block";
    }

    function closeStatsModal() {
      document.getElementById("statsModal").style.display = "none";
    }

    window.onclick = function(event) {
      if (event.target.className === 'modal') {
        event.target.style.display = "none";
      }
    }
  </script>

</body>
</html>
